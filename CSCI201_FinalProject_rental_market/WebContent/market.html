<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>Marketplace</title>
  <!-- Latest compiled and minified CSS -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">

  <!-- jQuery library -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

  <!-- Latest compiled JavaScript -->
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
  <link rel="stylesheet" href="styles/market.css" type="text/css">
  <link rel="stylesheet" type="text/css" href="styles/shell.css">
  <script>
  	var socket;
    // Use these variables to keep track of the content loaded
    var loadedProfile = false;
    var loadedMarket = true;
    var loadedRequest = false;
  	function populate() {
  		addImage();
  		addUserName();
  		addPostList();
  		showPostDetail();
  		connectToServer();
    }
  	window.onbeforeunload = function () {
  		socket.send("ActionB" + document.getElementById("usernameheader").innerHTML);
        socket.close();
    };
  	function connectToServer() {
  		socket = new WebSocket("ws://localhost:8080/CSCI201_FinalProject_rental_market/mks");
  		socket.onopen = function(event) {
  			socket.send("ActionA" + document.getElementById("usernameheader").innerHTML);
  		}
  		socket.onmessage = function(event) {
  			if(event.data == "New Post") {
  				var xhttp = new XMLHttpRequest();
  		  		xhttp.open("post", "marketNotification.jsp?notifyType=New Post", false);
  		  		xhttp.send();
  		  		if(xhttp.responseText.trim().length > 0){
  		  			document.getElementById("newpostnotify").innerHTML = xhttp.responseText;
  		  		}
  			}
  			else if(event.data == "New Request") {
  				var xhttp = new XMLHttpRequest();
  		  		xhttp.open("post", "marketNotification.jsp?notifyType=New Request", false);
  		  		xhttp.send();
  		  		if(xhttp.responseText.trim().length > 0){
  		  			document.getElementById("newrequestnotify").innerHTML = xhttp.responseText;
  		  		}
  			}
  			else if(event.data == "New Post Comment") {
  				var xhttp = new XMLHttpRequest();
  		  		xhttp.open("post", "marketNotification.jsp?notifyType=Post Comment", false);
  		  		xhttp.send();
  		  		if(xhttp.responseText.trim().length > 0){
  		  			document.getElementById("newpostcommentnotify").innerHTML = xhttp.responseText;
  		  		}
  			}
  			else if(event.data == "New Request Comment") {
  				var xhttp = new XMLHttpRequest();
  		  		xhttp.open("post", "marketNotification.jsp?notifyType=Request Comment", false);
  		  		xhttp.send();
  		  		if(xhttp.responseText.trim().length > 0){
  		  			document.getElementById("newrequestcommentnotify").innerHTML = xhttp.responseText;
  		  		}
  			}
  		}
  		socket.onclose = function(event) {
  			
  		}
  	}
    function addImage() {
    		var xhttp = new XMLHttpRequest();
  		xhttp.open("post", "addImage.jsp", false);
  		xhttp.send();
  		if(xhttp.responseText.trim().length > 0){
  			document.getElementById("profileimage").innerHTML = xhttp.responseText;
  		}
    }
    function addUserName() {
  		var xhttp = new XMLHttpRequest();
  		xhttp.open("post", "addUsername.jsp", false);
  		xhttp.send();
  		if(xhttp.responseText.trim().length > 0){
  			document.getElementById("UserNameField").innerHTML = xhttp.responseText;
  		}
	}
    function addPostList() {
  		var xhttp = new XMLHttpRequest();
  		xhttp.open("post", "marketPostList.jsp", false);
  		xhttp.send();
  		if(xhttp.responseText.trim().length > 0){
  			document.getElementById("currRequest").innerHTML = xhttp.responseText;
  		}
  		else {
  			document.getElementById("currRequest").innerHTML = "";
  		}
	}
    function requestSetting() {
    		document.getElementById("newrequestnotify").innerHTML = "";
    		document.getElementById("newrequestcommentnotify").innerHTML = "";
    		document.getElementById("marketplaceHead").innerHTML = "Requests";
    		addRequestList();
    		showRequestRight();
    		loadedProfile = false;
        loadedMarket = false;
        loadedRequest = true;
        switchHightlight();
    }
    function addRequestList() {
  		var xhttp = new XMLHttpRequest();
  		xhttp.open("post", "addRequestList.jsp", false);
  		xhttp.send();
  		if(xhttp.responseText.trim().length > 0){
  			document.getElementById("currRequest").innerHTML = xhttp.responseText;
  		}
  		else {
  			document.getElementById("currRequest").innerHTML = "";
  		}
	}
    function showRequestDetail(div) {
    		document.getElementById("newrequestnotify").innerHTML = "";
    		document.getElementById("newrequestcommentnotify").innerHTML = "";
		var xhttp = new XMLHttpRequest();
		xhttp.open("post", "addRequestDetail.jsp?requestID=" + div.id, false);
		xhttp.send();
		if(xhttp.responseText.trim().length > 0){
			document.getElementById("col7").innerHTML = xhttp.responseText;
		}
		else {
			document.getElementById("col7").innerHTML = "";
		}
	}
    function showRequestRight() {
		var xhttp = new XMLHttpRequest();
		xhttp.open("post", "addRequestDetail.jsp?requestID=-1", false);
		xhttp.send();
		if(xhttp.responseText.trim().length > 0){
			document.getElementById("col7").innerHTML = xhttp.responseText;
		}
		else {
  			document.getElementById("col7").innerHTML = "";
  		}
		loadedProfile = false;
    		loadedMarket = true;
    		loadedRequest = false;
    		switchHightlight();
	}
    function showDetail(div) {
    		document.getElementById("newpostcommentnotify").innerHTML = "";
    		document.getElementById("newpostnotify").innerHTML = "";
    		var xhttp = new XMLHttpRequest();
  		xhttp.open("post", "marketPostDetail.jsp?postID=" + div.id, false);
  		xhttp.send();
  		if(xhttp.responseText.trim().length > 0){
  			document.getElementById("col7").innerHTML = xhttp.responseText;
  		}
  		else {
  			document.getElementById("col7").innerHTML = "";
  		}
  		loadedProfile = false;
        loadedMarket = true;
        loadedRequest = false;
        switchHightlight();
    }
    function showPostDetail() {
    		document.getElementById("marketplaceHead").innerHTML = "Market";
    		document.getElementById("newpostnotify").innerHTML = "";
    		document.getElementById("newpostcommentnotify").innerHTML = "";
    		addPostList();
		var xhttp = new XMLHttpRequest();
		xhttp.open("post", "marketPostDetail.jsp?postID=-1", false);
		xhttp.send();
		if(xhttp.responseText.trim().length > 0){
			document.getElementById("col7").innerHTML = xhttp.responseText;
		}
		else {
  			document.getElementById("col7").innerHTML = "";
  		}
		loadedProfile = false;
    		loadedMarket = true;
    		loadedRequest = false;
    		switchHightlight();
	}
    function showProfileDetail() {
    		var xhttp = new XMLHttpRequest();
  		xhttp.open("post", "profileDetail.jsp", false);
  		xhttp.send();
  		if(xhttp.responseText.trim().length > 0){
  			document.getElementById("col7").innerHTML = xhttp.responseText;
  		}
      	loadedProfile = true;
      	loadedMarket = false;
      	loadedRequest = false;
      	switchHightlight();
    }
	function updatePostComment(postID, userID, userEmail) {
		var xhttp = new XMLHttpRequest();
  		xhttp.open("post", "updatePostComment.jsp?postID=" + postID + "&userID=" + userID + "&message=" + document.getElementById("userComment").value, false);
  		xhttp.send();
  		if(xhttp.responseText.trim().length > 0){
  			document.getElementById("userComment").value = "";
  			document.getElementById("postCommentSec").innerHTML = xhttp.responseText;
  			socket.send("ActionE" + userEmail);
  			return false;
  		}
  		else {
  			document.getElementById("userComment").value = "Please Enter a Comment";
  			return false;
  		}
	}
	function updateRequestComment(requestID, userID, userEmail) {
		var xhttp = new XMLHttpRequest();
  		xhttp.open("post", "updateRequestComment.jsp?requestID=" + requestID + "&userID=" + userID + "&message=" + document.getElementById("userComment").value, false);
  		xhttp.send();
  		if(xhttp.responseText.trim().length > 0){
  			document.getElementById("userComment").value = "";
  			document.getElementById("requestCommentSec").innerHTML = xhttp.responseText;
  			socket.send("ActionF" + userEmail);
  			return false;
  		}
  		else {
  			document.getElementById("userComment").value = "Please Enter a Comment";
  			return false;
  		}
	}
    // This will change the highlights depending on the content loaded
    function switchHightlight() {
      if (loadedProfile) {
        document.getElementById("profile").className = "active";
        document.getElementById("market").className = "";
        document.getElementById("request").className = "";
      }
      else if (loadedMarket) {
        document.getElementById("profile").className = "";
        document.getElementById("market").className = "active";
        document.getElementById("request").className = "";            }
      else if (loadedRequest) {
        document.getElementById("profile").className = "";
        document.getElementById("market").className = "";
        document.getElementById("request").className = "active";
      }
      document.getElementById("newRequestPButton").onclick = function() {
    	  	window.location.href = "newrequest.html";
      };
    }
   </script>
</head>

<body onload = "populate()">
	<div class="mainpage">
  		<div class="col-sm-2" id="col2">
    			<div id = "profileimage" class="profileimage">
    			</div>
    			<div id = "UserNameField">
    			</div>
    			<div id = "options">
    				<ul class="nav nav-pills nav-stacked">
      				<li id = "profile"><a href = "#" class="shellLink" onclick = "showProfileDetail()">Profile</a></li>
      				<li id = "market" class="active"><a href="#" class="shellLink" onclick = "showPostDetail()">Market</a></li>
      				<li id = "request"><a href="#" class="shellLink" onclick = "requestSetting()">Requests</a></li>
    				</ul><br>
    				<button id = "newRequestPButton" type="button" class="btn btn-default btn-block">New Request</button>
    			</div>
    			<div id = "notification">
    				<table id = "notify" class = "table table-border">
    					<thead>
    						<tr>
    							<th>Notifications</th>
    						</tr>
    					</thead>
    					<tbody>
    						<tr>
    							<td id = "newpostnotify"></td>
    						</tr>
    						<tr>
    							<td id = "newrequestnotify"></td>
    						</tr>
    						<tr>
    							<td id = "newpostcommentnotify"></td>
    						</tr>
    						<tr>
    							<td id = "newrequestcommentnotify"></td>
    						</tr>
    					</tbody>
    				</table>
    			</div>
  		</div>

  <!-- Dynamically create these cells -->
  <div class="col-sm-3" id="col3">
    <div class="well well-sm" id = "marketplaceHead">Marketplace</div>
    <div id = "currRequest">
    </div>
  </div>
  <div class="col-sm-7" id="col7">
  </div>
</body>

</html>
